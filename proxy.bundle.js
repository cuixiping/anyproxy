module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=14)}([function(e,t,r){"use strict";const n=r(1),o=r(2);let s=!0,i=0;const c={tip:0,system_error:1,rule_error:2,warn:3,debug:4};function a(e,t){if(!s)return;const r=o.formatDate(new Date,"YYYY-MM-DD hh:mm:ss");switch(t){case c.tip:if(i>0)return;console.log(n.cyan(`[AnyProxy Log][${r}]: `+e));break;case c.system_error:if(i>1)return;console.error(n.red(`[AnyProxy ERROR][${r}]: `+e));break;case c.rule_error:if(i>2)return;console.error(n.red(`[AnyProxy RULE_ERROR][${r}]: `+e));break;case c.warn:if(i>3)return;console.error(n.yellow(`[AnyProxy WARN][${r}]: `+e));break;case c.debug:return void console.log(n.cyan(`[AnyProxy Log][${r}]: `+e));default:console.log(n.cyan(`[AnyProxy Log][${r}]: `+e))}}e.exports.printLog=a,e.exports.debug=(e=>{a(e,c.debug)}),e.exports.info=(e=>{a(e,c.tip)}),e.exports.warn=(e=>{a(e,c.warn)}),e.exports.error=(e=>{a(e,c.system_error)}),e.exports.ruleError=(e=>{a(e,c.rule_error)}),e.exports.setPrintStatus=function(e){s=!!e},e.exports.setLogLevel=function(e){i=parseInt(e,10)},e.exports.T_TIP=c.tip,e.exports.T_ERR=c.system_error,e.exports.T_RULE_ERROR=c.rule_error,e.exports.T_WARN=c.warn,e.exports.T_DEBUG=c.debug},function(e,t){e.exports=require("colorful")},function(e,t,r){"use strict";const n=r(17),o=r(18),s=r(19),i=r(1),c=r(20),a=r(9).Buffer,l=r(0),u=r(8).networkInterfaces();let p;function d(){const e=p||o.join(process.env.HOME||process.env.USERPROFILE,"/.anyproxy/");return n.existsSync(e)||n.mkdirSync(e),e}e.exports.lower_keys=(e=>{for(const t in e){const r=e[t];delete e[t],e[t.toLowerCase()]=r}return e}),e.exports.merge=function(e,t){for(const r in t)e[r]=t[r];return e},e.exports.setAnyProxyHome=function(e){p=o.resolve(e)},e.exports.getAnyProxyHome=d,e.exports.getAnyProxyPath=function(e){const t=d(),r=o.join(t,e);return n.existsSync(r)||n.mkdirSync(r),r},e.exports.simpleRender=function(e,t,r){return String(e).replace(r||/\{\{([^{}]+)\}\}/g,(e,r)=>"\\"===e.charAt(0)?e.slice(1):null!=t[r]?t[r]:"")},e.exports.filewalker=function(e,t){e=e||process.cwd();const r={directory:[],file:[]};n.readdir(e,(s,i)=>{i&&i.length&&i.map(t=>{const s=o.join(e,t),i=n.lstatSync(s);i.isFile()?r.file.push({name:t,fullPath:s}):i.isDirectory()&&r.directory.push({name:t,fullPath:s})}),t&&t.apply(null,[null,r])})},e.exports.contentType=function(e){return s.contentType(o.extname(e))},e.exports.contentLength=function(e){try{return n.statSync(e).size}catch(t){return l.printLog(i.red("\nfailed to ready local file : "+e)),l.printLog(i.red(t)),0}},e.exports.formatDate=function(e,t){"object"!=typeof e&&(e=new Date(e));const r=function(e){return e<10?"0"+e:e};return t.replace(/^YYYY|MM|DD|hh|mm|ss/g,t=>{switch(t){case"YYYY":return r(e.getFullYear());case"MM":return r(e.getMonth()+1);case"mm":return r(e.getMinutes());case"DD":return r(e.getDate());case"hh":return r(e.getHours());case"ss":return r(e.getSeconds());default:return""}})},e.exports.getHeaderFromRawHeaders=function(e){const t={},r=function(e,r){t[e].constructor===Array?t[e].push(r):t[e]=[t[e],r]};if(e)for(let n=0;n<e.length;n+=2){const o=e[n];let s=e[n+1];"string"==typeof s&&(s=s.replace(/\0+$/g,"")),t[o]?"set-cookie"===o.toLowerCase()?r(o,s):t[o]=t[o]+","+s:t[o]=s}return t},e.exports.getAllIpAddress=function(){const e=[];return Object.keys(u).map(t=>{u[t].filter(t=>{"ipv4"===t.family.toLowerCase()&&e.push(t.address)})}),e.length?e:["127.0.0.1"]},e.exports.getFreePort=function(){return new Promise((e,t)=>{const n=r(10).createServer();n.unref(),n.on("error",t),n.listen(0,()=>{const t=n.address().port;n.close(()=>{e(t)})})})},e.exports.collectErrorLog=function(e){if(e&&e.code&&e.toString())return e.toString();{let t=[e,e.stack].join("\n");try{e.toString().indexOf("You may only yield a function")>=0&&(t="Function is not yieldable. Did you forget to provide a generator or promise in rule file ? \nFAQ http://anyproxy.io/4.x/#faq")}catch(e){}return t}},e.exports.isFunc=function(e){return e&&"[object Function]"===Object.tostring.call(e)},e.exports.getByteSize=function(e){return a.byteLength(e)},e.exports.isIpDomain=function(e){if(!e)return!1;return/^\d+?\.\d+?\.\d+?\.\d+?$/.test(e)},e.exports.execScriptSync=function(e){let t,r=0;try{t=c.execSync(e)}catch(e){t=e.stdout,r=e.status}return{stdout:t.toString(),status:r}},e.exports.guideToHomePage=function(){l.info("Refer to http://anyproxy.io for more detail")}},function(e,t){e.exports=require("co")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("async")},function(e,t,r){"use strict";const n=r(16),o=r(3),s=r(8),i=r(2),c=r(0),a={rootDirPath:"",inMemory:!1,defaultCertAttrs:[{name:"countryName",value:"CN"},{name:"organizationName",value:"AnyProxy"},{shortName:"ST",value:"SH"},{shortName:"OU",value:"AnyProxy SSL Proxy"}]},l={};let u=null;l.init=function(){if(u)throw new Error("crtMgr init duplicately");a.rootDirPath=i.getAnyProxyPath("certificates"),u=new n(a),i.merge(l,u)},l.ifRootCAFileExists=function(){if(!u)throw new Error("crtMgr not init");return u.isRootCAFileExists()},l.generateRootCA=function(e){if(!u)throw new Error("crtMgr not init");!function(t){const r={commonName:"AnyProxy",overwrite:!!t};u.generateRootCA(r,(t,r,n)=>{e(t,r,n)})}(!1)},l.getCAStatus=function*(){if(!u)throw new Error("crtMgr not init");return o(function*(){const e={exist:!1};return u.isRootCAFileExists()?(e.exist=!0,/^win/.test(process.platform)||(e.trusted=yield u.ifRootCATrusted),e):e})},l.trustRootCA=function*(){if(!u)throw new Error("crtMgr not init");const e=s.platform();l.getRootCAFilePath();"darwin"===e&&c.info("Please trust the root CA manually so https interception works"),/^win/.test(process.platform)&&c.info("You can install the root CA manually."),c.info("The root CA file path is: "+l.getRootCAFilePath())},e.exports=l},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("buffer")},function(e,t){e.exports=require("net")},function(e,t,r){const n=r(12),o=r(0),s=n.Server;e.exports.getWsServer=function(e){const t=new s({server:e.server});return t.on("connection",e.connHandler),t.on("headers",e=>{e.push("x-anyproxy-websocket:true")}),t.on("error",e=>{o.error(`error in websocket proxy: ${e.message},\r\n ${e.stack}`),console.error("error happened in proxy websocket:",e)}),t.on("close",e=>{console.error("==> closing the ws server")}),t}},function(e,t){e.exports=require("ws")},function(e,t){e.exports=require("stream")},function(e,t,r){e.exports=r(15)},function(e,t,r){"use strict";const n=r(5),o=r(4),s=r(6),i=r(1),c=r(7),a=r(0),l=r(2),u=r(21),p=r(3),d=r(11),h=r(22).ThrottleGroup,f="http",y="https",g=f,x="INIT",w="READY",m="CLOSED";class b extends u.EventEmitter{constructor(e){if(super(),e=e||{},this.status=x,this.proxyPort=e.port||0,this.proxyType=/https/i.test(e.type||g)?y:f,this.proxyHostName=e.hostname||"localhost",this.recorder=e.recorder,e.anyProxyHome&&l.setAnyProxyHome(e.anyProxyHome),this.proxyType===y&&c.init(),parseInt(process.versions.node.split(".")[0],10)<4)throw new Error("node.js >= v4.x is required for anyproxy");if(e.forceProxyHttps&&!c.ifRootCAFileExists())throw a.printLog("You can run `anyproxy-ca` to generate one root CA and then re-run this command"),new Error("root CA not found. Please run `anyproxy-ca` to generate one first.");if(this.proxyType===y&&!e.hostname)throw new Error("hostname is required in https proxy");if(e.forceProxyHttps&&e.rule&&e.rule.beforeDealHttpsRequest&&(a.printLog('both "-i(--intercept)" and rule.beforeDealHttpsRequest are specified, the "-i" option will be ignored.',a.T_WARN),e.forceProxyHttps=!1),this.httpProxyServer=null,this.requestHandler=null,this.proxyRule=e.rule||{},e.silent&&a.setPrintStatus(!1),e.throttle){a.printLog("throttle :"+e.throttle+"kb/s");const t=parseInt(e.throttle,10);if(t<1)throw new Error("Invalid throttle rate value, should be positive integer");global._throttle=new h({rate:1024*t})}this.recorder=e.recorder;const t=r(23);this.requestHandler=new t({wsIntercept:e.wsIntercept,httpServerPort:e.port,forceProxyHttps:!!e.forceProxyHttps,dangerouslyIgnoreUnauthorized:!!e.dangerouslyIgnoreUnauthorized},this.proxyRule,this.recorder)}handleExistConnections(e){const t=this;t.socketIndex++;const r=`socketIndex_${t.socketIndex}`;t.socketPool[r]=e,e.on("close",()=>{delete t.socketPool[r]})}start(){const e=this;if(e.socketIndex=0,e.socketPool={},e.status!==x)throw new Error("server status is not PROXY_STATUS_INIT, can not run start()");return s.series([function(t){e.proxyType===y?c.getCertificate(e.proxyHostName,(r,n,s)=>{r?t(r):(e.httpProxyServer=o.createServer({key:n,cert:s},e.requestHandler.userRequestHandler),t(null))}):(e.httpProxyServer=n.createServer(e.requestHandler.userRequestHandler),t(null))},function(t){e.httpProxyServer.on("connect",e.requestHandler.connectReqHandler),t(null)},function(t){d.getWsServer({server:e.httpProxyServer,connHandler:e.requestHandler.wsHandler}),e.httpProxyServer.on("connection",t=>{e.handleExistConnections.call(e,t)}),t(null)},function(t){e.httpProxyServer.listen(e.proxyPort,r=>{if(r)throw r;const n=e.httpProxyServer.address().port;e.proxyPort=n,t(null)})}],(t,r)=>{if(t){const r="err when start proxy server :(";a.printLog(i.red(r),a.T_ERR),a.printLog(t,a.T_ERR),e.emit("error",{error:t})}else{const t=(e.proxyType===f?"Http":"Https")+" proxy started on port "+e.proxyPort;if(a.printLog(i.green(t)),e.webServerInstance){const t="web interface started on port "+e.webServerInstance.webPort;a.printLog(i.green(t))}let r="";const n=this.proxyRule.summary;n&&p(function*(){r="string"==typeof n?n:yield n(),a.printLog(i.green(`Active rule is: ${r}`))}),e.status=w,e.emit("ready")}}),e}close(){return new Promise(e=>{if(this.httpProxyServer){for(const e of this.requestHandler.conns){const t=e[0],r=e[1];a.printLog(`destorying https connection : ${t}`),r.end()}for(const e of this.requestHandler.cltSockets){const t=e[0],r=e[1];a.printLog(`closing https cltSocket : ${t}`),r.end()}if(this.socketPool)for(const e in this.socketPool)this.socketPool[e].destroy();this.httpProxyServer.close(t=>{t?a.printLog(`proxy server close FAILED : ${t.message}`,a.T_ERR):(this.httpProxyServer=null,this.status=m,a.printLog(`proxy server closed at ${this.proxyHostName}:${this.proxyPort}`)),e(t)})}else e()})}}e.exports.ProxyCore=b,e.exports.ProxyServer=class extends b{constructor(e){super(Object.assign({},e)),this.proxyWebinterfaceConfig=e.webInterface,this.webServerInstance=null}start(){super.start()}close(){return new Promise((e,t)=>{super.close().then(t=>{t&&e(t)}),this.recorder&&(a.printLog("clearing cache file..."),this.recorder.clear());const r=this.webServerInstance;this.recorder=null,this.webServerInstance=null,r?(a.printLog("closing webserver..."),r.close(t=>{t?(console.error(t),a.printLog(`proxy web server close FAILED: ${t.message}`,a.T_ERR)):a.printLog(`proxy web server closed at ${this.proxyHostName} : ${this.webPort}`),e(t)})):e(null)})}},e.exports.utils={certMgr:c}},function(e,t){e.exports=require("node-easy-cert")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("mime-types")},function(e,t){e.exports=require("child_process")},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("stream-throttle")},function(e,t,r){"use strict";const n=r(5),o=r(4),s=r(10),i=r(24),c=r(25),a=r(1),l=r(9).Buffer,u=r(2),p=r(13),d=r(0),h=r(3),f=r(12),y=r(26),g=r(31),x=r(13).Readable,w=r(32);o.globalAgent.maxCachedSessions=0;const m=20971520;class b extends x{constructor(e){super({highWaterMark:5*m})}_read(e){}}const S=(e,t)=>{return{statusCode:500,header:{"Content-Type":"text/html; charset=utf-8","Proxy-Error":!0,"Proxy-Error-Message":e?JSON.stringify(e):"null"},body:w.getErrorContent(e,t)}};function v(e,t){const r=this;return function(s,f){const y=s.headers.host,x=s.connection.encrypted&&!/^http:/.test(s.url)?"https":"http",w="http"===x?s.url:x+"://"+y+s.url,v=i.parse(w),P=v.path,E=m;let R,T,_=null,H=-1;s.headers=u.getHeaderFromRawHeaders(s.rawHeaders),d.printLog(a.green(`received request to: ${s.method} ${y}${P}`));h(()=>new Promise(e=>{const t=[];s.on("data",e=>{t.push(e)}),s.on("end",()=>{R=l.concat(t),e()})})).then(()=>{const e={hostname:v.hostname||s.headers.host,port:v.port||s.port||(/https/.test(x)?443:80),path:P,method:s.method,headers:s.headers};return T={requestOptions:e,protocol:x,url:w,requestData:R,_req:s},Promise.resolve()}).then(()=>{t&&(_={host:y,method:s.method,path:P,protocol:x,url:x+"://"+y+P,req:s,startTime:(new Date).getTime()},H=t.appendRecord(_));try{_&&(_.reqBody=R.toString()),t&&t.updateRecord(H,_)}catch(e){}}).then(h.wrap(function*(){const t=(yield e.beforeSendRequest(Object.assign({},T)))||{},r={};return["protocol","requestOptions","requestData","response"].map(e=>{r[e]=t[e]||T[e]}),r})).then(h.wrap(function*(e){if(e.response)return e._directlyPassToRespond=!0,e;if(e.requestOptions){const p=yield(t=e.protocol,s=e.requestOptions,i=e.requestData,a={dangerouslyIgnoreUnauthorized:r.dangerouslyIgnoreUnauthorized,chunkSizeThreshold:E},i=i||"",new Promise((e,r)=>{if(delete s.headers["content-length"],delete s.headers["Content-Length"],delete s.headers["Transfer-Encoding"],delete s.headers["transfer-encoding"],a.dangerouslyIgnoreUnauthorized&&(s.rejectUnauthorized=!1),!a.chunkSizeThreshold)throw new Error("chunkSizeThreshold is required");const p=(/https/i.test(t)?o:n).request(s,t=>{t.headers=u.getHeaderFromRawHeaders(t.rawHeaders);const n=t.statusCode,o=t.headers;let s=[];const i=[];let p=null,h=0;const f=()=>{new Promise((e,t)=>{if(p)e(p);else{const r=l.concat(s),n=u.getByteSize(r),i=o["content-encoding"]||o["Content-Encoding"],a=/gzip/i.test(i),p=/deflate/i.test(i),d=/br/i.test(i),h=()=>{i&&(o["x-anyproxy-origin-content-encoding"]=i,delete o["content-encoding"],delete o["Content-Encoding"])};if(o["x-anyproxy-origin-content-length"]=n,a&&n)h(),c.gunzip(r,(r,n)=>{r?t(r):e(n)});else if(p&&n)h(),c.inflateRaw(r,(r,n)=>{r?t(r):e(n)});else if(d&&n){h();try{const n=g.decompress(r);e(l.from(n))}catch(e){t(e)}}else e(r)}}).then(r=>{e({statusCode:n,header:o,body:r,rawBody:i,_res:t})}).catch(e=>{r(e)})};t.on("data",e=>{if(i.push(e),p)p.push(e);else if(h+=e.length,s.push(e),h>=a.chunkSizeThreshold){for(p=new b;s.length;)p.push(s.shift());s=null,f()}}),t.on("end",()=>{p?p.push(null):f()}),t.on("error",e=>{d.printLog("error happend in response:"+e,d.T_ERR),r(e)})});p.on("error",r),p.end(i)}));return{response:{statusCode:p.statusCode,header:p.header,body:p.body,rawBody:p.rawBody},_res:p._res}}throw new Error("lost response or requestOptions, failed to continue");var t,s,i,a})).then(h.wrap(function*(t){return t._directlyPassToRespond?t:t.response.body&&t.response.body instanceof b?t:(yield e.beforeSendResponse(Object.assign({},T),Object.assign({},t)))||t})).catch(h.wrap(function*(t){d.printLog(u.collectErrorLog(t),d.T_ERR);let r=S(t,w);try{const n=yield e.onError(Object.assign({},T),t);n&&n.response&&n.response.header&&(r=n.response)}catch(e){}return{response:r}})).then(e=>{const t=e.response,r=t.header,n=t.body||"",o=r["transfer-encoding"]||r["Transfer-Encoding"]||"",s=r["content-length"]||r["Content-Length"],i=r.Connection||r.connection;if(s&&(delete r["content-length"],delete r["Content-Length"]),i&&(r["x-anyproxy-origin-connection"]=i,delete r.connection,delete r.Connection),!t)throw new Error("failed to get response info");if(!t.statusCode)throw new Error("failed to get response status code");if(!t.header)throw new Error("filed to get response header");if(global._throttle||"chunked"===o||n instanceof b||(r["Content-Length"]=u.getByteSize(n)),f.writeHead(t.statusCode,r),global._throttle)if(n instanceof b)n.pipe(global._throttle.throttle()).pipe(f);else{const e=new p;e.pipe(global._throttle.throttle()).pipe(f),e.emit("data",n),e.emit("end")}else n instanceof b?n.pipe(f):f.end(n);return t}).then(e=>{_&&t&&(_.endTime=(new Date).getTime(),_.res={statusCode:e.statusCode,headers:e.header},_.statusCode=e.statusCode,_.resHeader=e.header,_.resBody=e.body instanceof b?"(big stream)":e.body||"",_.length=_.resBody.length,t&&t.updateRecord(H,_))}).catch(e=>{d.printLog(a.green("Send final response failed:"+e.message),d.T_ERR)})}}function P(e,t,r,n){const o=this;try{let e=-1;const s={wsMessages:[]},i=[],c=function(e){const t=e.headers||{},r=t.host,n=r.split(":")[0],o=r.split(":")[1],s=e.url||"/",i=e.connection&&e.connection.encrypted;return{headers:t,noWsHeaders:(()=>{const e=Object.assign({},t);return Object.keys(e).forEach(t=>{/sec-websocket/gi.test(t)&&delete e[t]}),delete e.connection,delete e.upgrade,e})(),hostName:n,port:o,path:s,protocol:i?"wss":"ws"}}(n),a=`${c.protocol}://${c.hostName}:${c.port}${c.path}`,l=new f(a,"",{rejectUnauthorized:!o.dangerouslyIgnoreUnauthorized,headers:c.noWsHeaders});t&&(Object.assign(s,{host:c.hostName,method:"WebSocket",path:c.path,url:a,req:n,startTime:(new Date).getTime()}),e=t.appendRecord(s));const u=e=>{const t=e.data;1===l.readyState?i.length>0?i.push(t):l.send(t):i.push(t)},p=()=>{for(;i.length>0;){const e=i.shift();l.send(e)}},h=e=>{const t=e.code||"",r=e.reason||"";let n="",o="";return t>=1004&&t<=1006?(n=1e3,o=`Normally closed. The origin ws is closed at code: ${t} and reason: ${r}`):(n=t,o=r),{code:n,reason:o}},y=(r,n)=>{const o={time:Date.now(),message:r.data,isToServer:n};t&&t.updateRecordWsMessage(e,o)};l.onopen=(()=>{p()}),l.on("upgrade",r=>{if(!t||!s)return;s.endTime=(new Date).getTime();const n=r.headers;s.res={statusCode:r.statusCode,headers:n},s.statusCode=r.statusCode,s.resHeader=n,s.resBody="",s.length=s.resBody.length,t&&t.updateRecord(e,s)}),l.onerror=(e=>{r.close(1001,e.message),l.close(1001)}),l.onmessage=(e=>{y(e,!1),1===r.readyState&&r.send(e.data)}),l.onclose=(e=>{d.debug(`proxy ws closed with code: ${e.code} and reason: ${e.reason}`);const t=h(e);3!==r.readyState&&r.close(t.code,t.reason)}),r.onmessage=(e=>{y(e,!0),u(e)}),r.onclose=(e=>{d.debug(`original ws closed with code: ${e.code} and reason: ${e.reason}`);const t=h(e);3!==l.readyState&&l.close(t.code,t.reason)})}catch(e){d.debug("WebSocket Proxy Error:"+e.message),d.debug(e.stack),console.error(e)}}e.exports=class{constructor(e,t,n){this.forceProxyHttps=!1,this.dangerouslyIgnoreUnauthorized=!1,this.httpServerPort="",this.wsIntercept=!1,e.forceProxyHttps&&(this.forceProxyHttps=!0),e.dangerouslyIgnoreUnauthorized&&(this.dangerouslyIgnoreUnauthorized=!0),e.wsIntercept&&(this.wsIntercept=e.wsIntercept),this.httpServerPort=e.httpServerPort;const o=r(35),i=u.merge(o,t);this.userRequestHandler=v.apply(this,[i,n]),this.wsHandler=P.bind(this,i,n),this.httpsServerMgr=new y({handler:this.userRequestHandler,wsHandler:this.wsHandler}),this.connectReqHandler=function(e,t,r){const n=this;return n.conns=new Map,n.cltSockets=new Map,function(o,i,c){const l=o.url.split(":")[0],p=o.url.split(":")[1];let f,y,g=!1,x=null,w=-1;const m=new b;h(function*(){d.printLog(a.green("received https CONNECT request "+l)),y={host:o.url,_req:o},null===(f=yield e.beforeDealHttpsRequest(y))&&(f=n.forceProxyHttps)}).then(()=>new Promise(e=>{i.write("HTTP/"+o.httpVersion+" 200 OK\r\n\r\n","UTF-8",e)})).then(()=>new Promise((t,r)=>{let o=!1;i.on("data",e=>{if(m.push(e),!o){o=!0;try{const t=e.toString();0===t.indexOf("GET ")&&(f=!1,n.wsIntercept&&0!==t.indexOf("GET /do-not-proxy")&&(g=!0))}catch(e){console.error(e)}t()}}),i.on("error",t=>{d.printLog(u.collectErrorLog(t),d.T_ERR),h.wrap(function*(){try{yield e.onClientSocketError(y,t)}catch(e){}})}),i.on("end",()=>{m.push(null)})})).then(e=>{f?d.printLog("will forward to local https server"):d.printLog("will bypass the man-in-the-middle proxy"),t&&(x={host:l,method:o.method,path:"",url:"https://"+l,req:o,startTime:(new Date).getTime()},w=t.appendRecord(x))}).then(()=>{if(f)return r.getSharedHttpsServer(l).then(e=>({host:e.host,port:e.port}));{const e={host:l,port:80===p?443:p},t={host:"localhost",port:n.httpServerPort};return g?t:e}}).then(e=>{if(!e.port||!e.host)throw new Error("failed to get https server info");return new Promise((t,r)=>{const o=s.connect(e.port,e.host,()=>{global._throttle&&!f?(m.pipe(o),o.pipe(global._throttle.throttle()).pipe(i)):(m.pipe(o),o.pipe(i)),t()});o.on("error",e=>{r(e)}),n.conns.set(e.host+":"+e.port,o),n.cltSockets.set(e.host+":"+e.port,i)})}).then(()=>{t&&x&&(x.endTime=(new Date).getTime(),x.statusCode="200",x.resHeader={},x.resBody="",x.length=0,t&&t.updateRecord(w,x))}).catch(h.wrap(function*(t){d.printLog(u.collectErrorLog(t),d.T_ERR);try{yield e.onConnectError(y,t)}catch(e){}try{let e="Proxy-Error: true\r\n";e+="Proxy-Error-Message: "+(t||"null")+"\r\n",e+="Content-Type: text/html\r\n",i.write("HTTP/1.1 502\r\n"+e+"\r\n\r\n")}catch(e){}}))}}.apply(this,[i,n,this.httpsServerMgr])}}},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("zlib")},function(e,t,r){"use strict";const n=r(6),o=r(4),s=r(27),i=r(28),c=r(29),a=r(1),l=r(7),u=r(0),p=r(2),d=r(11),h=r(3),f=r(30),y=s.createSecureContext||c.createSecureContext;function g(e,t){let r,o,s;n.series([t=>{l.getCertificate(e,(e,n,s)=>{e?t(e):(r=n,o=s,t())})},e=>{try{s=y({key:r,cert:o}),e()}catch(t){e(t)}}],r=>{if(r)u.printLog("err occurred when prepare certs for SNI - "+r,u.T_ERR),u.printLog("err occurred when prepare certs for SNI - "+r.stack,u.T_ERR);else{const r="proxy server for __NAME established".replace("__NAME",e);u.printLog(a.yellow(a.bold("[internal https]"))+a.yellow(r)),t(null,s)}})}e.exports=class{constructor(e){if(!e||!e.handler)throw new Error("handler is required");this.instanceDefaultHost="127.0.0.1",this.httpsAsyncTask=new f,this.handler=e.handler,this.wsHandler=e.wsHandler}getSharedHttpsServer(e){const t=p.isIpDomain(e)?e:this.instanceDefaultHost,r=this;function n(n){let s;h(p.getFreePort).then(h.wrap(function*(c){s=c;let a=null;a=p.isIpDomain(e)?yield function(e){if(!e||!e.port||!e.handler)throw new Error("please assign a port");if(!e.ip)throw new Error("please assign an IP to create the https server");return new Promise(t=>{l.getCertificate(e.ip,(r,n,s)=>{const c=o.createServer({secureOptions:i.SSL_OP_NO_SSLv3||i.SSL_OP_NO_TLSv1,key:n,cert:s},e.handler).listen(e.port);t(c)})})}({ip:e,port:c,handler:r.handler}):yield function(e){if(!e||!e.port||!e.handler)throw new Error("please assign a port");return new Promise(t=>{l.getCertificate("anyproxy_internal_https_server",(r,n,s)=>{const c=o.createServer({secureOptions:i.SSL_OP_NO_SSLv3||i.SSL_OP_NO_TLSv1,SNICallback:g,key:n,cert:s},e.handler).listen(e.port);t(c)})})}({port:c,handler:r.handler}),d.getWsServer({server:a,connHandler:r.wsHandler}),a.on("upgrade",(e,t,r)=>{u.debug("will let WebSocket server to handle the upgrade event")});const h={host:t,port:s};return n(null,h),h})).catch(e=>{n(e)})}return new Promise((e,o)=>{r.httpsAsyncTask.addTask(`createHttpsServer-${t}`,n,(t,r)=>{t?o(t):e(r)})})}}},function(e,t){e.exports=require("tls")},function(e,t){e.exports=require("constants")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("async-task-mgr")},function(e,t){e.exports=require("brotli")},function(e,t,r){"use strict";const n=r(33),o=r(34);e.exports.getErrorContent=function(e,t){let r="";switch((e=e||{}).code){case"UNABLE_TO_GET_ISSUER_CERT_LOCALLY":r=function(e,t){let r,n="There are error with the certfication of the site.";switch(e.code){case"UNABLE_TO_GET_ISSUER_CERT_LOCALLY":n="The certfication of the site you are visiting is not issued by a known agency, It usually happenes when the cert is a self-signed one.</br>If you know and trust the site, you can run AnyProxy with option <strong>-ignore-unauthorized-ssl</strong> to continue.";break;default:n=""}try{r=o({title:"The connection is not private. ",explain:n,code:e.code})}catch(t){r=e.stack}return r}(e);break;default:r=function(e,t){let r;try{r=n({error:e,url:t,errorStack:e.stack.split(/\n/)})}catch(t){r=e.stack}return r}(e,t)}return r}},function(e,t){e.exports=(e=>`<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8" />\n<title>AnyProxy Inner Error</title>\n<style type="text/css">\n    body {\n      color: #666;\n      line-height: 1.5;\n      font-size: 13px;\n      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,PingFang SC,Hiragino Sans GB,Microsoft YaHei,SimSun,sans-serif;\n    }\n\n    body * {\n      box-sizing: border-box;\n    }\n\n    .stackError {\n      border-radius: 5px;\n      padding: 20px;\n      border: 1px solid #fdc;\n      background-color: #ffeee6;\n      color: #666;\n    }\n    .stackError li {\n      list-style-type: none;\n    }\n    .infoItem {\n      position: relative;\n      overflow: hidden;\n      border: 1px solid #d5f1fd;\n      background-color: #eaf8fe;\n      border-radius: 4px;\n      margin-bottom: 5px;\n      padding-left: 70px;\n    }\n    .infoItem .label {\n      position: absolute;\n      top: 0;\n      left: 0;\n      bottom: 0;\n      display: flex;\n      justify-content: flex-start;\n      align-items: center;\n      width: 70px;\n      font-weight: 300;\n      background-color: #76abc1;\n      color: #fff;\n      padding: 5px;\n    }\n    .infoItem .value {\n      overflow:hidden;\n      padding: 5px;\n    }\n\n    .tipItem .label {\n      background-color: #ecf6fd;\n    }\n    .tip {\n      color: #808080;\n    }\n</style>\n</head>\n<body>\n    <h1>AnyProxy Inner Error</h1>\n    <h3>Oops! Error happend when AnyProxy handle the request.</h3>\n    <p class="tip">This is an error occurred inside AnyProxy, not from your target website.</p>\n    <div class="infoItem">\n      <div class="label">Error:</div>\n      <div class="value">${e.error}</div>\n    </div>\n    <div class="infoItem">\n      <div class="label">URL:</div>\n      <div class="value">${e.url}</div>\n    </div>\n    <div class="infoItem">\n      <div class="label">TIP:</div>\n      <div class="value">${e.tipMessage}</div>\n    </div>\n    <p>\n      <ul class="stackError">\n        ${e.errorStack.map(e=>"<li>"+e+"</li>").join("")}\n      <ul>\n\t</p>\n</body>\n</html>\n`)},function(e,t){e.exports=(e=>`<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8" />\n<title>Security Vulnerable</title>\n<style type="text/css">\n    body {\n      color: #666;\n      line-height: 1.5;\n      font-size: 13px;\n      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,PingFang SC,Hiragino Sans GB,Microsoft YaHei,SimSun,sans-serif;\n    }\n\n    body * {\n      box-sizing: border-box;\n    }\n\n    .container {\n      max-width: 1200px;\n      padding: 20px;\n      padding-top: 150px;\n      margin: 0 auto;\n    }\n\n    .title {\n      font-size: 20px;\n      margin-bottom: 20px;\n    }\n\n    .explain {\n      font-size: 14px;\n      font-weight: 200;\n      color: #666;\n    }\n\n    .explainCode {\n      color: #999;\n      margin-bottom: 10px;\n    }\n</style>\n</head>\n<body>\n    <div class="container">\n\t\t\n      <div class="title">${e.title}</div>\n      <div class="explainCode">${e.code}</div>\n      <div class="explain">${e.explain}</div>\n    </div>\n</body>\n</html>\n`)},function(e,t,r){"use strict";e.exports={summary:"the default rule for AnyProxy",*beforeSendRequest(e){return null},*beforeSendResponse(e,t){return null},*beforeDealHttpsRequest(e){return null},*onError(e,t){return null},*onConnectError(e,t){return null},*onClientSocketError(e,t){return null}}}]);